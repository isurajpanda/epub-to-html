// --- START: Embedded toc_and_topbar.js logic ---
function truncateText(t,e=50){if(!t||t.length<=e)return t;const n=t.substring(0,e),r=n.lastIndexOf(" ");return r>e*.7?n.substring(0,r).trim()+"...":n.trim()+"..."}
function buildTocList(t,e){const n=document.createElement("ul"),r=document.createDocumentFragment();for(let o=0,a=t.length;o<a;o++){const a=t[o],i=document.createElement("li");if(a.href){const t=document.createElement("a");t.textContent=truncateText(a.label,45),t.title=a.label,t.href=a.href,t.onclick=n=>{n.preventDefault(),e&&e(a,n)},i.appendChild(t)}else{const t=document.createElement("span");t.textContent=truncateText(a.label,45),t.title=a.label,t.style.color="GrayText",i.appendChild(t)}a.children&&a.children.length&&i.appendChild(buildTocList(a.children,e)),r.appendChild(i)}return n.appendChild(r),n}
// --- END: Embedded toc_and_topbar.js logic ---

// --- START: Application Logic ---
let _appDataCache=null,_bionicObserver=null,_bionicSet=new WeakSet;
const getAppData=()=>{if(_appDataCache)return _appDataCache;const t=document.getElementById("app-data");try{_appDataCache=JSON.parse(t.textContent),t.textContent="",t.remove()}catch(e){_appDataCache={}}return _appDataCache};

const injectMemoryStyles=()=>{const t=document.createElement("style");t.textContent=`
.chapter{content-visibility:auto;contain-intrinsic-size:1px 1000px;contain:layout paint style}
#main-content{will-change:scroll-position}
img{content-visibility:auto;contain-intrinsic-size:100px 300px}
.bionic-active .bionic-wrapper{display:inline}
.b-word{display:inline-block}
.b-bold{font-weight:700}
.b-fade{opacity:.65}
.font-option.active{background-color:var(--link-color);color:#fff;border-color:var(--link-color)}
`,document.head.appendChild(t)};

const scrollToElement=t=>{t&&(window.setScrollspyNavigating&&window.setScrollspyNavigating(!0),t.scrollIntoView({behavior:"auto",block:"start"}),setTimeout(()=>{window.setScrollspyNavigating&&window.setScrollspyNavigating(!1)},100))};

const handleTocClick=(t,e)=>{window.innerWidth<768&&toggleSidebar();if(t.href){const e=t.href.includes("#")?t.href.substring(t.href.indexOf("#")+1):null;if(e){const t=document.getElementById(e);t&&(scrollToElement(t),history.replaceState(null,null,"#"+e))}}};

const createTopbar=()=>{const t=document.getElementById("topbar-container");if(!t)return;const e=getAppData().epub_filename||"";t.innerHTML=`<div class="top-toolbar"><div class="top-left-controls"><button type="button" title="Show sidebar" aria-label="Show sidebar" id="sidebar-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/></svg></button><button type="button" title="Previous Chapter" aria-label="Previous Chapter" id="prev-chapter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5"/></svg></button><button type="button" title="Next Chapter" aria-label="Next Chapter" id="next-chapter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8"/></svg></button></div><div class="top-right-controls"><button id="settings-toggle" class="icon-button" aria-label="Settings"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1z"/></svg></button>${e?`<a href="/epub/${e}" title="Download EPUB" aria-label="Download EPUB" id="download-epub" download><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/></svg></a>`:""}<button type="button" title="Toggle fullscreen" aria-label="Toggle fullscreen" id="fullscreen-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5M.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5"/></svg></button></div></div>`};

const createSidebar=t=>{const e=document.createElement("aside");e.id="sidebar-container";const n=t.cover_image_url?`<img id="book-cover" src="${t.cover_image_url}" alt="Book cover" loading="lazy">`:'<img id="book-cover" src="" alt="Book cover" style="display: none;">';e.innerHTML=`<div class="toc-sidebar"><div class="toc-sidebar-header">${n}<div class="book-info"><h1 id="book-title">${t.title?truncateText(t.title,60):""}</h1><p id="book-author">${t.author?truncateText(t.author,40):""}</p></div></div><div class="toc-view" id="toc-list"></div></div>`,t.title||(e.querySelector("#book-title").style.display="none"),t.author||(e.querySelector("#book-author").style.display="none"),document.getElementById("app-container").appendChild(e);const r=document.getElementById("toc-list");return t.toc&&r&&r.appendChild(buildTocList(t.toc,handleTocClick)),e};

const createSettingsPanel=()=>{const t=document.createElement("aside");return t.id="settings-sidebar-container",t.innerHTML=`<div class="settings-sidebar"><div class="settings-header"><h2>Reader Settings</h2><button id="settings-close" aria-label="Close settings">×</button></div><div class="settings-content"><div class="settings-section"><div class="font-size-control"><div id="font-size-preview" class="font-size-preview">Lorem ipsum</div><button id="bionic-reading-toggle" class="font-option" aria-label="Toggle Bionic Reading"><span>Bionic Reading</span></button><h3>Font Size</h3><div class="slider-container"><span class="size-label small">A</span><input type="range" id="font-size-slider" min="12" max="40" step="2" value="18" aria-label="Font size"><span class="size-label large">A</span></div></div></div><div class="settings-section"><h3>Font Family</h3><div class="font-family-grid"><button class="font-option active" data-font="original" style="font-family: serif">Original</button><button class="font-option" data-font="montserrat" style="font-family: sans-serif">Montserrat</button><button class="font-option" data-font="arial" style="font-family: Arial, sans-serif">Arial</button><button class="font-option" data-font="verdana" style="font-family: Verdana, sans-serif">Verdana</button><button class="font-option" data-font="roboto-condensed" style="font-family: sans-serif">Roboto</button><button class="font-option" data-font="comic-sans" style="font-family: cursive">Comic</button></div><div class="setting-group"><div class="theme-header"><h3>Theme</h3><div class="mode-toggle"><span class="mode-label">Light</span><label class="switch"><input type="checkbox" id="theme-mode-toggle"><span class="slider round"></span></label><span class="mode-label">Dark</span></div></div><div class="theme-options"><button class="theme-option active" data-theme="classic"><div class="theme-preview classic"></div><span>Classic</span></button><button class="theme-option" data-theme="vintage"><div class="theme-preview vintage"></div><span>Vintage</span></button><button class="theme-option" data-theme="lipstick"><div class="theme-preview lipstick"></div><span>Lipstick</span></button><button class="theme-option" data-theme="ocean"><div class="theme-preview ocean"></div><span>Ocean</span></button><button class="theme-option" data-theme="cyber"><div class="theme-preview cyber"></div><span>Cyber</span></button><button class="theme-option" data-theme="nature"><div class="theme-preview nature"></div><span>Nature</span></button></div></div></div></div></div>`,document.getElementById("app-container").appendChild(t),initSettings(),t};

const createImageModal=()=>{const t=document.createElement("div");return t.id="image-modal",t.className="image-modal",t.innerHTML='<div class="image-modal-content"><img id="modal-image" src="" alt="Image"><button id="modal-close" class="image-modal-close" title="Close">×</button></div>',document.body.appendChild(t),t};

const createSidebarOverlay=()=>{if(document.getElementById("sidebar-overlay"))return;const t=document.createElement("div");t.id="sidebar-overlay",t.className="sidebar-overlay",document.body.appendChild(t),t.addEventListener("click",t=>{t.target.closest("aside")||(document.getElementById("app-container").classList.contains("sidebar-open")?toggleSidebar():document.getElementById("app-container").classList.contains("settings-open")&&toggleSettings())})};

const togglePanel=t=>{const e=document.getElementById("app-container");createSidebarOverlay(),"sidebar"===t&&!document.getElementById("sidebar-container")&&createSidebar(getAppData()),"settings"===t&&!document.getElementById("settings-sidebar-container")&&createSettingsPanel();const n="sidebar"===t?"sidebar-open":"settings-open",r="sidebar"===t?"settings-open":"sidebar-open";e.classList.remove(r),e.classList.toggle(n),window.innerWidth<=768&&document.getElementById("sidebar-overlay").classList.toggle("active",e.classList.contains(n)),"settings"===t&&syncBionicButtonState()};
const toggleSidebar=()=>togglePanel("sidebar"),toggleSettings=()=>togglePanel("settings");

const updateFontSize=t=>{document.querySelector('.content-body').style.fontSize=`${t}px`;const e=document.getElementById("font-size-preview"),n=document.getElementById("font-size-slider");e&&(e.style.fontSize=`${t}px`),n&&(n.value=t)};

const updateFontFamily=t=>{const e={original:"serif",montserrat:"system-ui, -apple-system, sans-serif",arial:"Arial, sans-serif",verdana:"Verdana, sans-serif","roboto-condensed":"'Arial Narrow', sans-serif","comic-sans":"'Comic Sans MS', cursive"},n=e[t]||t;document.querySelector('.content-body').style.fontFamily=n;const r=document.getElementById("font-size-preview");r&&(r.style.fontFamily=n),document.querySelectorAll(".font-option[data-font]").forEach(e=>e.classList.toggle("active",e.dataset.font===t))};

const processBionicNode=t=>{if(_bionicSet.has(t))return;const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null),n=[];let r;while(r=e.nextNode())r.nodeValue.trim().length>0&&n.push(r);n.forEach(t=>{const e=t.nodeValue,n=e.split(/(\s+)/),r=document.createElement("span");r.className="bionic-wrapper",n.forEach(t=>{if(!t.trim())return r.appendChild(document.createTextNode(t)),void 0;const e=t.length,n=Math.ceil(e/2),o=document.createElement("span");o.className="b-word";const a=document.createElement("span");a.className="b-bold",a.textContent=t.substring(0,n),o.appendChild(a);const i=document.createElement("span");i.className="b-fade",i.textContent=t.substring(n),o.appendChild(i),r.appendChild(o)}),t.parentNode&&t.parentNode.replaceChild(r,t)}),_bionicSet.add(t)};

const revertBionicNode=t=>{if(!_bionicSet.has(t))return;const e=t.querySelectorAll(".bionic-wrapper");e.forEach(t=>{t.parentNode&&t.parentNode.replaceChild(document.createTextNode(t.textContent),t)}),_bionicSet.delete(t),t.normalize()};

const applyBionicReading=()=>{const t=document.querySelector(".content-body");if(!t)return;t.classList.add("bionic-active"),syncBionicButtonState(),_bionicObserver&&_bionicObserver.disconnect(),_bionicSet=new WeakSet,_bionicObserver=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting?processBionicNode(t.target):revertBionicNode(t.target)})},{rootMargin:"100% 0px 100% 0px",threshold:0});const e=document.querySelectorAll(".content-body p, .content-body li, .content-body blockquote, #font-size-preview");e.forEach(t=>_bionicObserver.observe(t))};

const removeBionicReading=()=>{const t=document.querySelector(".content-body");if(!t)return;t.classList.remove("bionic-active"),syncBionicButtonState(),_bionicObserver&&(_bionicObserver.disconnect(),_bionicObserver=null);const e=document.querySelectorAll(".bionic-wrapper");e.forEach(t=>{t.parentNode.replaceChild(document.createTextNode(t.textContent),t)})};

const toggleBionic=()=>{document.querySelector(".content-body").classList.contains("bionic-active")?removeBionicReading():applyBionicReading()};

const syncBionicButtonState=()=>{const t=document.getElementById("bionic-reading-toggle"),e=document.querySelector(".content-body");t&&e&&(e.classList.contains("bionic-active")?t.classList.add("active"):t.classList.remove("active"))};

const themes={classic:{light:{"--bg-color":"#f4f6f8","--text-color":"#1f2937","--sidebar-bg":"#f4f6f8","--sidebar-border":"#e5e7eb","--sidebar-text":"#1f2937","--sidebar-hover-bg":"#e5e7eb","--topbar-bg":"#f4f6f8","--topbar-button-hover":"#e5e7eb","--separator-color":"#e5e7eb","--link-color":"#2563eb","--link-visited":"#1d4ed8"},dark:{"--bg-color":"#000000","--text-color":"#ffffff","--sidebar-bg":"#000000","--sidebar-border":"#333333","--sidebar-text":"#ffffff","--sidebar-hover-bg":"#1a1a1a","--topbar-bg":"#000000","--topbar-button-hover":"#1a1a1a","--separator-color":"#333333","--link-color":"#60a5fa","--link-visited":"#3b82f6"}},vintage:{light:{"--bg-color":"#f5e6d3","--text-color":"#5c4033","--sidebar-bg":"#f5e6d3","--sidebar-border":"#e6d2b5","--sidebar-text":"#5c4033","--sidebar-hover-bg":"#e6d2b5","--topbar-bg":"#f5e6d3","--topbar-button-hover":"#e6d2b5","--separator-color":"#e6d2b5","--link-color":"#a0522d","--link-visited":"#8b4513"},dark:{"--bg-color":"#2b2b00","--text-color":"#ffffcc","--sidebar-bg":"#3d3d00","--sidebar-border":"#5c5c00","--sidebar-text":"#ffffcc","--sidebar-hover-bg":"#5c5c00","--topbar-bg":"#3d3d00","--topbar-button-hover":"#5c5c00","--separator-color":"#5c5c00","--link-color":"#edc152ff","--link-visited":"#cccc00"}},lipstick:{light:{"--bg-color":"#ffc0cb","--text-color":"#880e4f","--sidebar-bg":"#ffc0cb","--sidebar-border":"#ff69b4","--sidebar-text":"#880e4f","--sidebar-hover-bg":"#ff69b4","--topbar-bg":"#ffc0cb","--topbar-button-hover":"#ff69b4","--separator-color":"#ff69b4","--link-color":"#c2185b","--link-visited":"#880e4f"},dark:{"--bg-color":"#2a0a18","--text-color":"#ffd1ea","--sidebar-bg":"#3d0f23","--sidebar-border":"#5c1635","--sidebar-text":"#ffd1ea","--sidebar-hover-bg":"#5c1635","--topbar-bg":"#3d0f23","--topbar-button-hover":"#5c1635","--separator-color":"#5c1635","--link-color":"#ff6b9d","--link-visited":"#ff4d88"}},ocean:{light:{"--bg-color":"#87ceeb","--text-color":"#0d47a1","--sidebar-bg":"#87ceeb","--sidebar-border":"#4fc3f7","--sidebar-text":"#0d47a1","--sidebar-hover-bg":"#4fc3f7","--topbar-bg":"#87ceeb","--topbar-button-hover":"#4fc3f7","--separator-color":"#4fc3f7","--link-color":"#1565c0","--link-visited":"#0d47a1"},dark:{"--bg-color":"#001e3c","--text-color":"#b4dcff","--sidebar-bg":"#002850","--sidebar-border":"#004080","--sidebar-text":"#b4dcff","--sidebar-hover-bg":"#004080","--topbar-bg":"#002850","--topbar-button-hover":"#004080","--separator-color":"#004080","--link-color":"#38bdf8","--link-visited":"#0ea5e9"}},cyber:{light:{"--bg-color":"#f9f0ff","--text-color":"#4b0082","--sidebar-bg":"#f9f0ff","--sidebar-border":"#d8bfd8","--sidebar-text":"#4b0082","--sidebar-hover-bg":"#d8bfd8","--topbar-bg":"#f9f0ff","--topbar-button-hover":"#d8bfd8","--separator-color":"#d8bfd8","--link-color":"#9400d3","--link-visited":"#8a2be2"},dark:{"--bg-color":"#0a001e","--text-color":"#ffffff","--sidebar-bg":"#140028","--sidebar-border":"#2a0050","--sidebar-text":"#ffffff","--sidebar-hover-bg":"#2a0050","--topbar-bg":"#140028","--topbar-button-hover":"#2a0050","--separator-color":"#2a0050","--link-color":"#ff00ff","--link-visited":"#d500d5"}},nature:{light:{"--bg-color":"#f0fff4","--text-color":"#006400","--sidebar-bg":"#f0fff4","--sidebar-border":"#98fb98","--sidebar-text":"#006400","--sidebar-hover-bg":"#98fb98","--topbar-bg":"#f0fff4","--topbar-button-hover":"#98fb98","--separator-color":"#98fb98","--link-color":"#32cd32","--link-visited":"#228b22"},dark:{"--bg-color":"#143214","--text-color":"#c8e6b4","--sidebar-bg":"#1e461e","--sidebar-border":"#2d692d","--sidebar-text":"#c8e6b4","--sidebar-hover-bg":"#2d692d","--topbar-bg":"#1e461e","--topbar-button-hover":"#2d692d","--separator-color":"#2d692d","--link-color":"#4ade80","--link-visited":"#22c55e"}}};
let currentThemeFamily="classic",currentThemeMode="dark";
const updateTheme=()=>{const t=document.documentElement,e=themes[currentThemeFamily]?.[currentThemeMode];e&&Object.entries(e).forEach(([e,n])=>t.style.setProperty(e,n));document.body.classList.remove("light-mode","dark-mode"),document.body.classList.add(`${currentThemeMode}-mode`),document.querySelectorAll(".theme-option").forEach(t=>t.classList.toggle("active",t.dataset.theme===currentThemeFamily));const n=document.getElementById("theme-mode-toggle");n&&(n.checked="dark"===currentThemeMode)};

const initSettings=()=>{updateTheme(),document.getElementById("font-size-slider")?.addEventListener("input",t=>updateFontSize(t.target.value)),syncBionicButtonState();const t=document.querySelector(".settings-content");t&&(t.addEventListener("click",t=>{const e=t.target.closest("button");e&&(e.dataset.font&&updateFontFamily(e.dataset.font),e.dataset.theme&&(currentThemeFamily=e.dataset.theme,updateTheme()))}),document.getElementById("theme-mode-toggle")?.addEventListener("change",t=>{currentThemeMode=t.target.checked?"dark":"light",updateTheme()})),updateFontSize("18")};

const toggleFullscreen=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen().catch(()=>{})};
const downloadEpub=()=>{const t=getAppData().epub_filename;if(t){const e=document.createElement("a");e.href="../"+t,e.download=t,e.click()}};

const navigateChapter=t=>{const e=Array.from(document.querySelectorAll(".chapter[id]"));if(!e.length)return;const n=window.location.hash.substring(1);let r=e.findIndex(t=>t.id===n);-1===r&&(r=e.findIndex(t=>t.offsetTop>=document.getElementById("main-content").scrollTop)||0);const a="next"===t?r+1:r-1;a>=0&&a<e.length&&(scrollToElement(e[a]),history.replaceState(null,null,"#"+e[a].id))};

let savedScroll=0;
const openImageModal=(t,e)=>{document.getElementById("image-modal")||createImageModal();const n=document.getElementById("image-modal"),r=document.getElementById("modal-image");n&&r&&(savedScroll=document.getElementById("main-content").scrollTop,r.src=t,r.alt=e||"",n.classList.add("active"),document.body.style.overflow="hidden")};
const closeImageModal=()=>{const t=document.getElementById("image-modal");if(!t)return;t.classList.remove("active"),document.body.style.overflow="";const e=document.getElementById("modal-image");e&&(e.src=""),document.getElementById("main-content").scrollTo(0,savedScroll)};

document.addEventListener("click",t=>{const e=t.target.closest("button");if(e)switch(e.id){case"sidebar-toggle":toggleSidebar();break;case"prev-chapter":navigateChapter("prev");break;case"next-chapter":navigateChapter("next");break;case"settings-toggle":case"settings-close":toggleSettings();break;case"download-epub":downloadEpub();break;case"fullscreen-toggle":toggleFullscreen();break;case"modal-close":closeImageModal();break;case"bionic-reading-toggle":toggleBionic()}const n=t.target.closest("img");n&&n.closest(".content-body")&&!document.getElementById("app-container").classList.contains("sidebar-open")&&!document.getElementById("app-container").classList.contains("settings-open")&&(t.preventDefault(),openImageModal(n.src,n.alt));"image-modal"===t.target.id&&!t.target.closest("#modal-image")&&closeImageModal();const r=t.target.closest('a[href^="#"]');if(r&&!t.defaultPrevented){const e=r.getAttribute("href"),n=document.getElementById(e.substring(1));n&&(t.preventDefault(),scrollToElement(n),history.replaceState(null,null,e))}});

document.addEventListener("keydown",t=>{"Escape"===t.key&&closeImageModal();if(["INPUT","TEXTAREA"].includes(t.target.tagName))return;const e=t.key.toLowerCase();["a","d","arrowleft","arrowright"].includes(e)&&(t.preventDefault(),"a"===e||"arrowleft"===e?navigateChapter("prev"):navigateChapter("next")),"f"===e&&(t.preventDefault(),toggleFullscreen())});

document.addEventListener("DOMContentLoaded",()=>{injectMemoryStyles(),createTopbar();const t=document.getElementById("main-content");let e=!1;window.setScrollspyNavigating=t=>e=t;let n=null;const r=Array.from(document.querySelectorAll(".chapter[id]"));if(r.length){const a=new IntersectionObserver(t=>{if(e)return;const r=t.reduce((t,e)=>e.intersectionRatio>t.intersectionRatio?e:t);r.intersectionRatio>0&&r.target.id!==window.location.hash.substring(1)&&(n&&clearTimeout(n),n=setTimeout(()=>{history.replaceState(null,null,"#"+r.target.id)},150))},{root:t,threshold:[0,.1]});r.forEach(t=>a.observe(t))}window.location.hash&&setTimeout(()=>{const t=document.getElementById(window.location.hash.substring(1));scrollToElement(t)},50),document.addEventListener("fullscreenchange",()=>{const t=document.fullscreenElement,e=document.getElementById("app-container"),n=document.querySelector(".top-toolbar");e.classList.toggle("is-fullscreen",t),n&&n.classList.toggle("fullscreen-hidden",t),!t&&n&&(n.style.display="none",n.offsetHeight,n.style.display="")})});
// --- END: Application Logic ---