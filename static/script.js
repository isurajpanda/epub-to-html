function truncateText(text,maxLength=50){if(!text||text.length<=maxLength){return text;}
const truncated=text.substring(0,maxLength);const lastSpaceIndex=truncated.lastIndexOf(' ');if(lastSpaceIndex>maxLength*0.7){return truncated.substring(0,lastSpaceIndex).trim()+'...';}
return truncated.trim()+'...';}
function buildTocList(items,onTocClick){const ul=document.createElement('ul');for(const item of items){const li=document.createElement('li');if(item.href){const a=document.createElement('a');a.textContent=truncateText(item.label,45);a.title=item.label;a.href='#';a.onclick=e=>{e.preventDefault();if(onTocClick)onTocClick(item);};li.appendChild(a);}else{const span=document.createElement('span');span.textContent=truncateText(item.label,45);span.title=item.label;span.style.color='GrayText';li.appendChild(span);}
if(item.children&&item.children.length){li.appendChild(buildTocList(item.children,onTocClick));}
ul.appendChild(li);}
return ul;}
const toggleSidebar=()=>{const appContainer=document.getElementById('app-container');const tocOverlay=document.getElementById('toc-overlay');if(appContainer){const isOpen=appContainer.classList.toggle('sidebar-open');if(tocOverlay&&window.innerWidth<768){if(isOpen){tocOverlay.classList.add('active');}else{tocOverlay.classList.remove('active');}}}};const toggleFontSize=()=>{const contentBody=document.querySelector('.content-body');if(!contentBody)return;const sizeClasses=['text-sm','text-base','text-lg','text-xl','text-2xl'];const currentClass=sizeClasses.find(cls=>contentBody.classList.contains(cls))||'text-base';const currentIndex=sizeClasses.indexOf(currentClass);const nextIndex=(currentIndex+1)%sizeClasses.length;sizeClasses.forEach(cls=>contentBody.classList.remove(cls));contentBody.classList.add(sizeClasses[nextIndex]);};const toggleFullscreen=()=>{if(!document.fullscreenElement){document.documentElement.requestFullscreen().catch(err=>{console.log('Error attempting to enable fullscreen:',err);});}else{document.exitFullscreen();}};const downloadEpub=()=>{const appDataElement=document.getElementById('app-data');if(!appDataElement)return;const appData=JSON.parse(appDataElement.textContent);const epubFilename=appData.epub_filename;if(!epubFilename){console.log('No EPUB filename found in metadata');return;}
const downloadLink=document.createElement('a');downloadLink.href='../'+epubFilename;downloadLink.download=epubFilename;downloadLink.style.display='none';document.body.appendChild(downloadLink);downloadLink.click();document.body.removeChild(downloadLink);};const navigateChapter=(direction)=>{const chapters=Array.from(document.querySelectorAll('.chapter'));if(chapters.length===0)return;const mainContent=document.getElementById('main-content');const topbarContainer=document.getElementById('topbar-container');if(!mainContent||!topbarContainer)return;const currentScroll=mainContent.scrollTop;const topbarHeight=topbarContainer.offsetHeight;const viewportHeight=mainContent.clientHeight;let targetChapter=null;if(direction==='next'){for(const chapter of chapters){const chapterTop=chapter.offsetTop;const chapterBottom=chapterTop+chapter.offsetHeight;const visibleBottom=currentScroll+viewportHeight;if(chapterTop>=visibleBottom){targetChapter=chapter;break;}}
if(!targetChapter){targetChapter=chapters[chapters.length-1];}}else{for(let i=chapters.length-1;i>=0;i--){const chapter=chapters[i];const chapterTop=chapter.offsetTop;const chapterBottom=chapterTop+chapter.offsetHeight;const visibleTop=currentScroll;if(chapterTop<visibleTop-50){targetChapter=chapter;break;}}
if(!targetChapter){targetChapter=chapters[0];}}
if(targetChapter){const scrollPosition=Math.max(0,targetChapter.offsetTop);mainContent.scrollTo(0,scrollPosition);}};let savedScrollPosition=0;const openImageModal=(imageSrc,imageAlt)=>{if(window.innerWidth>768)return;const modal=document.getElementById('image-modal');const modalImage=document.getElementById('modal-image');const mainContent=document.getElementById('main-content');if(!modal||!modalImage||!mainContent)return;savedScrollPosition=mainContent.scrollTop;modalImage.src=imageSrc;modalImage.alt=imageAlt||'Image';modal.classList.add('active');document.body.style.overflow='hidden';};const closeImageModal=()=>{const modal=document.getElementById('image-modal');const mainContent=document.getElementById('main-content');if(!modal||!mainContent)return;const viewport=document.querySelector('meta[name="viewport"]');if(viewport){viewport.setAttribute('content','width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');setTimeout(()=>{viewport.setAttribute('content','width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes');},100);}
modal.classList.remove('active');document.body.style.overflow='';setTimeout(()=>{mainContent.scrollTo(0,savedScrollPosition);},100);};document.addEventListener('click',(event)=>{const target=event.target.closest('button');if(!target)return;switch(target.id){case'sidebar-toggle':event.preventDefault();if(!target.classList.contains('button-loading')){toggleSidebar();}
break;case'prev-chapter':event.preventDefault();navigateChapter('prev');break;case'next-chapter':event.preventDefault();navigateChapter('next');break;case'font-size-toggle':event.preventDefault();toggleFontSize();break;case'download-epub':event.preventDefault();downloadEpub();break;case'fullscreen-toggle':event.preventDefault();toggleFullscreen();break;case'modal-close':event.preventDefault();closeImageModal();break;}});document.addEventListener('click',(event)=>{if(window.innerWidth>768)return;const img=event.target.closest('img');if(!img||!img.closest('.content-body'))return;event.preventDefault();event.stopPropagation();openImageModal(img.src,img.alt);});document.addEventListener('click',(event)=>{const modal=document.getElementById('image-modal');if(event.target===modal){closeImageModal();}});document.addEventListener('keydown',(event)=>{if(window.innerWidth>768)return;const modal=document.getElementById('image-modal');if(!modal||!modal.classList.contains('active'))return;if(event.key==='Escape'){closeImageModal();}});document.addEventListener('DOMContentLoaded',()=>{const APP_DATA=JSON.parse(document.getElementById('app-data').textContent);const sidebarToggle=document.getElementById('sidebar-toggle');if(sidebarToggle){sidebarToggle.classList.remove('button-loading');sidebarToggle.classList.remove('loading-spinner');sidebarToggle.title='Show sidebar';sidebarToggle.setAttribute('aria-label','Show sidebar');const svg=sidebarToggle.querySelector('svg');if(svg){svg.classList.remove('loading-spinner');}}
let isRedirected=false;let wasTocOpenBeforeFullscreen=false;const appContainer=document.getElementById('app-container');const sidebarContainer=document.getElementById('sidebar-container');const topbarContainer=document.getElementById('topbar-container');const mainContent=document.getElementById('main-content');const tocOverlay=document.getElementById('toc-overlay');if(tocOverlay){tocOverlay.addEventListener('click',(event)=>{if(event.target.closest('#sidebar-container')){return;}
if(appContainer&&appContainer.classList.contains('sidebar-open')){event.preventDefault();event.stopPropagation();toggleSidebar();}});}
let scrollToElement=(element,smooth=false)=>{if(!element)return;const scrollPosition=Math.max(0,element.offsetTop);mainContent.scrollTo(0,scrollPosition);};const contentIdMapping=APP_DATA.content_id_mapping||{};const toggleFullscreen=()=>{const topbarContainer=document.getElementById('topbar-container');const mainContent=document.getElementById('main-content');const appContainer=document.getElementById('app-container');const isFs=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);const enter=async()=>{try{if(appContainer.classList.contains('sidebar-open')){wasTocOpenBeforeFullscreen=true;appContainer.classList.remove('sidebar-open');}else{wasTocOpenBeforeFullscreen=false;}
const el=document.documentElement;if(el.requestFullscreen)await el.requestFullscreen();else if(el.webkitRequestFullscreen)await el.webkitRequestFullscreen();else if(el.mozRequestFullScreen)await el.mozRequestFullScreen();else if(el.msRequestFullscreen)await el.msRequestFullscreen();appContainer.classList.add('is-fullscreen');const topToolbar=topbarContainer.querySelector('.top-toolbar');if(topToolbar)topToolbar.classList.add('fullscreen-hidden');startFullscreenPoll();setTimeout(handleFullscreenChange,300);setTimeout(handleFullscreenChange,1000);}catch(e){}};const exit=async()=>{try{if(document.exitFullscreen)await document.exitFullscreen();else if(document.webkitExitFullscreen)await document.webkitExitFullscreen();else if(document.mozCancelFullScreen)await document.mozCancelFullScreen();else if(document.msExitFullscreen)await document.msExitFullscreen();appContainer.classList.remove('is-fullscreen');const topToolbar=topbarContainer.querySelector('.top-toolbar');if(topToolbar)topToolbar.classList.remove('fullscreen-hidden');stopFullscreenPoll();if(wasTocOpenBeforeFullscreen){appContainer.classList.add('sidebar-open');}
setTimeout(handleFullscreenChange,300);setTimeout(handleFullscreenChange,1000);}catch(e){}};if(!isFs)enter();else exit();};const handleFullscreenChange=()=>{const topbarContainer=document.getElementById('topbar-container');const appContainer=document.getElementById('app-container');const isFullscreen=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);const topToolbar=topbarContainer&&topbarContainer.querySelector('.top-toolbar');if(isFullscreen){appContainer.classList.add('is-fullscreen');if(topToolbar)topToolbar.classList.add('fullscreen-hidden');}else{appContainer.classList.remove('is-fullscreen');if(topToolbar){topToolbar.classList.remove('fullscreen-hidden');topToolbar.style.opacity='1';topToolbar.style.visibility='visible';topToolbar.style.pointerEvents='auto';}
stopFullscreenPoll();}
if(topToolbar){topToolbar.style.display='none';topToolbar.offsetHeight;topToolbar.style.display='';}};let _fullscreenPollId=null;let _fullscreenPollTimeout=null;const startFullscreenPoll=()=>{if(_fullscreenPollId)return;_fullscreenPollId=setInterval(()=>{const isFsNow=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);if(!isFsNow){handleFullscreenChange();clearInterval(_fullscreenPollId);_fullscreenPollId=null;if(_fullscreenPollTimeout){clearTimeout(_fullscreenPollTimeout);_fullscreenPollTimeout=null;}}},300);_fullscreenPollTimeout=setTimeout(()=>{if(_fullscreenPollId){clearInterval(_fullscreenPollId);_fullscreenPollId=null;}
_fullscreenPollTimeout=null;},10000);};const stopFullscreenPoll=()=>{if(_fullscreenPollId){clearInterval(_fullscreenPollId);_fullscreenPollId=null;}
if(_fullscreenPollTimeout){clearTimeout(_fullscreenPollTimeout);_fullscreenPollTimeout=null;}};document.addEventListener('fullscreenchange',handleFullscreenChange);document.addEventListener('webkitfullscreenchange',handleFullscreenChange);document.addEventListener('mozfullscreenchange',handleFullscreenChange);document.addEventListener('MSFullscreenChange',handleFullscreenChange);document.addEventListener('visibilitychange',()=>{if(!document.hidden)handleFullscreenChange();});window.addEventListener('orientationchange',handleFullscreenChange);window.addEventListener('resize',handleFullscreenChange);window.addEventListener('focus',handleFullscreenChange);window.addEventListener('resize',handleFullscreenChange);const handleTocClick=(item)=>{if(!item.href)return;let pageId=item.href;if(pageId.startsWith('#')){pageId=pageId.substring(1);}
let targetElement=document.getElementById(pageId);if(!targetElement){const chapterElements=document.querySelectorAll('.chapter');if(chapterElements.length>0){targetElement=chapterElements[0];pageId=targetElement.id;}}
if(targetElement){history.replaceState(null,'','#'+pageId);scrollToElement(targetElement,false);}else{}
if(window.innerWidth<768){toggleSidebar();}};const handleKeyDown=(event)=>{if(event.target&&(event.target.tagName==='INPUT'||event.target.tagName==='TEXTAREA'||event.target.contentEditable==='true')){return;}
const key=(event.key||'').toLowerCase();if(['a','d','arrowleft','arrowright','f','t'].includes(key)){event.preventDefault();}
switch(key){case'a':case'arrowleft':navigateChapter('prev');break;case'd':case'arrowright':navigateChapter('next');break;case'arrowup':case'w':return;case'arrowdown':case's':return;case'f':toggleFullscreen();break;case't':toggleFontSize();break;}};document.addEventListener('keydown',handleKeyDown,{passive:false});const bookCover=document.getElementById('book-cover');const bookTitle=document.getElementById('book-title');const bookAuthor=document.getElementById('book-author');const tocList=document.getElementById('toc-list');if(APP_DATA.cover_image_url&&bookCover){bookCover.src=APP_DATA.cover_image_url;bookCover.style.display='block';}
if(APP_DATA.title&&bookTitle){bookTitle.textContent=truncateText(APP_DATA.title,60);bookTitle.title=APP_DATA.title;bookTitle.style.display='block';}
if(APP_DATA.author&&bookAuthor){bookAuthor.textContent=truncateText(APP_DATA.author,40);bookAuthor.title=APP_DATA.author;bookAuthor.style.display='block';}
if(APP_DATA.toc&&tocList){tocList.appendChild(buildTocList(APP_DATA.toc,handleTocClick));}
mainContent.addEventListener('click',()=>{if(appContainer.classList.contains('sidebar-open')){toggleSidebar();}});const scrollTargets=Array.from(mainContent.querySelectorAll('div.chapter[id], h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]'));let activeHashId=null;let isProgrammaticScroll=false;let isInitialLoad=true;});window.addEventListener('load',()=>{const sidebarToggle=document.getElementById('sidebar-toggle');if(sidebarToggle&&sidebarToggle.classList.contains('button-loading')){sidebarToggle.classList.remove('button-loading');sidebarToggle.classList.remove('loading-spinner');sidebarToggle.title='Show sidebar';sidebarToggle.setAttribute('aria-label','Show sidebar');const svg=sidebarToggle.querySelector('svg');if(svg){svg.classList.remove('loading-spinner');}}});